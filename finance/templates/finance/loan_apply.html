{% extends "finance/layouts.html" %}

{% block body %}
<div class="max-w-2xl mx-auto mt-10">
    <div class="bg-white rounded-lg shadow-lg p-8">
        <h2 class="text-2xl font-bold mb-6 text-indigo-700">Apply for a Loan</h2>

        <div class="space-y-6">
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Amount to Borrow (KES)</label>
                <input v-model.number="amount" type="number" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition" placeholder="e.g. 50000">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Repayment Period (Months)</label>
                <input v-model.number="duration" type="range" min="1" max="24" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                <div class="text-right text-sm text-gray-500 mt-1">[[ duration ]] Months</div>
            </div>

            <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                <h4 class="font-semibold text-indigo-800 text-sm uppercase tracking-wide">Repayment Preview</h4>
                <div class="mt-2 grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <p class="text-gray-500">Principal:</p>
                        <p class="font-medium">KES [[ amount || 0 ]]</p>
                    </div>
                    <div>
                        <p class="text-gray-500">Interest (12%):</p>
                        <p class="font-medium text-indigo-600">+ KES [[ interest.toFixed(2) ]]</p>
                    </div>
                </div>
                <div class="mt-3 pt-3 border-t border-indigo-200 flex justify-between items-center">
                    <span class="font-bold text-gray-700">Total Repayment:</span>
                    <span class="font-bold text-xl text-indigo-700">KES [[ total.toFixed(2) ]]</span>
                </div>
            </div>

            <button @click="submitLoan" :disabled="loading || amount <= 0" 
                class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
                <span v-if="loading">Processing...</span>
                <span v-else>Submit Application</span>
            </button>

            <p v-if="message" :class="success ? 'text-green-600' : 'text-red-600'" class="text-center mt-4 font-medium">
                [[ message ]]
            </p>

        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
    const { createApp, ref, computed } = Vue;

    createApp({
        setup() {
            const amount = ref(0);
            const duration = ref(12);
            const loading = ref(false);
            const message = ref('');
            const success = ref(false);

            // Real-time Calculation (Computed Property)
            const interest = computed(() => {
                // Simple Interest Formula: P * R * T
                return (amount.value * 0.12 * (duration.value / 12));
            });

            const total = computed(() => {
                return amount.value + interest.value;
            });

            const submitLoan = async () => {
                loading.value = true;
                message.value = '';
                
                try {
                    const res = await fetch('/api/apply-loan/', {
                        method: 'POST',
                        body: JSON.stringify({
                            amount: amount.value,
                            duration: duration.value
                        })
                    });
                    
                    const data = await res.json();
                    
                    if (data.success) {
                        success.value = true;
                        message.value = "Application Submitted Successfully! Redirecting...";
                        setTimeout(() => window.location.href = "/", 2000); // Send back to dashboard
                    } else {
                        success.value = false;
                        message.value = data.error || "Something went wrong.";
                    }

                } catch (e) {
                    success.value = false;
                    message.value = "Network Error";
                } finally {
                    loading.value = false;
                }
            };

            return {
                amount,
                duration,
                interest,
                total,
                submitLoan,
                loading,
                message,
                success
            }
        },
        compilerOptions: { delimiters: ['[[', ']]'] }
    }).mount('#app');
</script>
{% endblock %}